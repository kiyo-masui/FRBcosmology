\documentclass[twocolumn,prl,nofootinbib]{revtex4-1}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bm}
\usepackage{color}
\usepackage{verbatim}
\usepackage{times}
\usepackage{afterpage}



% shortcuts
%\newcommand{\ud}{\,\mathrm{d}}
\newcommand{\bD}{\boldsymbol D}
\newcommand{\bC}{\boldsymbol C}
\newcommand{\bDelta}{\boldsymbol \Delta}
\newcommand{\Dgal}{D^{\rm gal}}
\newcommand{\Dne}{D^{\bar{n}_e}}
\newcommand{\Dde}{D^{\delta_e}}
\newcommand{\Dsrc}{D^{\rm src}}
\newcommand{\del}{\delta\!}
\newcommand{\calP}{{\cal P}}
\newcommand{\ud}{\,\mathrm{d}}



% for draft comments.
\newcommand{\red}{\textcolor{red}}
\newcommand{\blue}{\textcolor{blue}}
\newcommand{\green}{\textcolor{green}}


\begin{document}

\title{The large scale clustering in dispersion measure space}

\author{Kiyoshi Wesley Masui}
 \affiliation{Department of Physics and Astronomy, University of British 
Columbia, Vancouver, BC, Canada, V6T 1Z1}
 \affiliation{Canadian Institute for Advanced Research, CIFAR Program in
Cosmology and Gravity, Toronto, ON, Canada, M5G 1Z8}

\author{Kris Sigurdson}
 \affiliation{Department of Physics and Astronomy, University of British 
Columbia, Vancouver, BC, Canada, V6T 1Z1}


\begin{abstract}

    The recently discovered fast radio bursts are a new class of radio
    transient that, due to their high dispersion from intervening plasma,
    have been interpreted as
    originating from cosmological distances.  The rate of fast radio bursts
    has been estimated to be as high as 10\,000 per sky per day.  If
    cosmological, these events should trace the large-scale structure of the
    Universe in some way. Furthermore, because the dispersion measure (DM) can be
    used as a proxy for radial distance (like redshift),
    clustering can be studied in three dimensions. Due to inhomogeneities in
    the plasma's density dispersion measure is an imperfect proxy or radial
    distance and we show that this leads to additional clustering terms---the
    dispersion measure space distortions. We calculate the DM space
    power spectra for a toy model of electron and FRB clustering and show that
    the clustering signal could be detected in a survey of \red{10000} FRB
    events, as is expected to be produced by the Canadian Hydrogen Intensity
    Mapping Experiment.

\end{abstract}

\maketitle

\section{Introduction}


\section{Density perturbations in dispersion measure space}

The dispersion measure of a signal observed in some angular direction $\hat{n}$ and
originating from co moving radial distance $\chi$ is
\begin{equation}
    {\rm DM}(\hat{n}, \chi) = \int_0^{\chi} \ud\chi' a(\chi)^2
        n_e(\hat{n}\chi', \chi').
\end{equation}
Here
$n_e(\vec{x}, \chi)$ is the free electron density as a function of location and
conformal time. Note that we use $\chi$ as our radial distance and time
coordinate, as opposed to redshift which is more appropriate for spectroscopic
applications. We model the cosmological 
electron density as containing a homogeneous part
and perturbations
$n_e(\vec x, \chi) = \bar{n}_e(\chi) \left[1 + \delta_e(\vec x, \chi)\right]$.  \red{We take
all of the electrons to be in a diffuse ionized state such that
$\bar{n}_e(\chi) = \bar{n}_{e0} / a(\chi)^3$ (not necessary).} The dispersion
measure is thus
\begin{equation}
    {\rm DM}(\hat n, \chi) = \int_0^\chi \ud\chi' a(\chi')^2 \bar{n}_e(\chi')
       \left[1 + \delta_e(\hat{n}\chi',\chi')\right].
\end{equation}

\emph{Dispersion measure space} is the three dimensional coordinates,
$\vec x_s$ inferred from the dispersion measure assuming that the electrons are
homogenious. This only affect the radial coordinate such that $\vec x_s = \hat
n \chi_s$ with $\chi_s$ defined by the equation
\begin{equation}
    {\rm DM}(\chi_s) = \int_0^\chi \ud\chi' a(\chi')^2 \bar{n}_e(\chi').
\end{equation}

Combining the above equations (keeping only terms first order in the density
perturbations), we find that
\begin{equation}
\frac{\ud \chi_s}{\ud \chi} = (1 + \delta_e(\hat n \chi, \chi),
\end{equation}
and thus
\begin{equation}
\chi_s - \chi = \int_0^\chi \ud \chi' \delta_e(\hat n \chi').
\end{equation}

We wish to relate the density of a tracer $f$ measured in DM space to its
density in real space. We follow the derivation in \citet{Kaiser} of the
redshift space distortions. Start by noting that the total number of tracers
in a volume element is the same in both spaces:
\begin{equation}
\label{e:density}
n_{fs}(\vec x_s) \ud^3\vec x_s = n_{f}(\vec x) \ud^3\vec x.
\end{equation}
We split the density into a homogeneous part plus perturbations,
\begin{equation}
    \bar{n}_{fs}(\chi_s)\left[ 1 + \delta_{fs}(\vec x_s)\right] \ud^3\vec x_s
    = \bar{n}_{f}(\chi)\left[ 1 + \delta_f(\vec x)\right] \ud^3\vec x.
\end{equation}
Averaged over the sky, the density should be the same in DM 
space as in real space,
\begin{equation}
\bar{n}_{fs}(\chi) = \bar{n}_f(\chi).
\end{equation}
Therefore,
\begin{align}
\bar{n}_{fs}(\chi_s) 
    &= \bar{n}_{f}(\chi) + (\chi_s - \chi)\frac{\ud \bar{n}_f}{\ud \chi}\\
    &= \bar{n}_{f}(\chi)
       + \frac{\ud \bar{n}_f}{\ud \chi}\int_0^\chi \ud \chi' \delta_e(\hat n \chi')
       \label{e:nfs}
\end{align}

The Jacobian in spherical coordinates is
\begin{align}
\left| \frac{\ud^3\vec x}{\ud^3\vec x_s} \right|
    &= \frac{\ud \chi}{\ud \chi_s}\frac{\chi^2}{\chi_s^2}\\
    &= (1 + \delta_e)^{-1}
       \left(1 + \frac{\int_0^\chi \ud \chi' \delta_e(\hat n \chi')}
                      {\chi}\right)^{-2}\\
    &\approx 1 - \delta_e
        - \frac{2}{\chi}\int_0^\chi \ud \chi' \delta_e(\hat n \chi')
        \label{e:jac}
\end{align}

Substituting Equations~\ref{e:nfs}~and~\ref{e:jac} into Equation~\ref{e:density},
we obtain
\begin{equation}
\label{e:delta_s}
    \delta_{fs} = \delta_f - \delta_e
    - \left(\frac{1}{\bar{n}_f}\frac{\ud \bar{n}_f}{\ud \chi}
    + \frac{2}{\chi} \right)
        \int_0^\chi \ud \chi' \delta_e(\hat n \chi').
\end{equation}
In the equation above, the $-\delta_e$ term is most analogous to the Kaiser
redshift space distortions.  It is a dilution of tracers in DM space due to an
excess of electrons in between the tracers. However we note that this term is isotropic
in contrast to Kaiser.  This is because any wave vector electron perturbation
causes DM space distortions, whereas the radial velocities that cause
redshift space distortions are only sourced by perturbations with radial wave
vectors.

The $\frac{1}{\bar{n}_f}\frac{\ud \bar{n}_f}{\ud \chi}$ arise since the
misinterpretation of the radial distance causes the observed tracer density to
be compared to the wrong background density. The $\frac{2}{\chi}$ term is
caused by a misinterpretation of angular distances when the radial distance is
mis measured.  Both terms are in-principle present in redshift space but are
negligible. Because radial velocities are only sourced by modes with large
radial wave vector, there is near perfect cancellation along the line of sight
and thus is very little net error in radial distance.

For brevity in the following sections we define the coefficient of the integral
term as
\begin{equation}
    A(\chi) \equiv \frac{1}{\bar{n}_f}\frac{\ud \bar{n}_f}{\ud \chi}
    + \frac{2}{\chi}.
\end{equation}

\section{Two-point statistics in DM space}

Unlike in redshift-space distortions, Equation~\ref{e:delta_s} does not have a
simple form in harmonic space. The equation's third term couples harmonic modes
and thus the two-point statistics cannot be phrased as a simple power spectrum.
We will phrase the two point statistic in terms of $C^{ss}_\ell(\chi,\chi')$, which is
the cross-correlation angular power-spectrum of the DM space over-density
on shells at $\chi$ and $\chi'$.
\begin{align}
    &\delta_{\ell\ell'}\delta_{mm'}C^{ss}_\ell(\chi, \chi') = \nonumber \\
    & \quad
        \left\langle
        \int\ud\Omega Y_{\ell m}(\hat n)
       \delta_{fs}(\hat n \chi, \chi)
        \int\ud\Omega' Y_{\ell' m'}(\hat n')
        \delta_{fs}(\hat n' \chi', \chi')
        \right\rangle
\end{align}
The first two term in Equation~\ref{e:delta_s} are stationary. For stationary,
isotropic, tracers $x$ and $y$ we have 
$\langle \delta_x(\vec k, \chi) \delta_y(\vec k', \chi) \rangle = (2\pi)^3
\delta^3(\vec k - \vec k') P_{xy}(k, \chi)$.  If for a moment we ignore time
dependance, the angular cross power spectrum of such tracers is
\begin{align}
    %\delta_{\ell\ell'}\delta_{mm'}C^{xy}_\ell(\chi, \chi')
    %&= \int\ud\Omega\ud\Omega'Y_{\ell m}(\hat n) Y_{\ell' m'}(\hat n')
    %    \langle \delta_x(\hat n \chi) \delta_y(\hat n' \chi') \rangle,
    %    \\
    C^{xy}_\ell(\chi,\chi')
    &= \frac{2}{\pi}
\int_0^\infty\ud k k^2 j_\ell(k\chi) j_{\ell}(k\chi')P_{xy}(k).
\end{align}
In reality the power spectrum evolves on the order of a Hubble time.
The angular cross-correlations will be very small unless $\chi$ and $\chi'$ are
within a few correlation lengths of one another, roughly a few hundred
megaparsecs.  The evolution of the power-spectrum is negligible over these time
differences which leads to a straight forward way to include the evolution of
the perturbations:
\begin{align}
C^{xy}_\ell(\chi,\chi') 
    \approx \frac{2}{\pi}
    \int_0^\infty\ud k k^2
    j_\ell(k\chi) j_{\ell}(k\chi')
    P_{xy}(k,(\chi + \chi')/2),\nonumber &\\
    |\chi - \chi'| \ll 1/aH.&
\end{align}

The thrid term in Equation~\ref{e:delta_s} is not stationary but is an integral
over the stationary field $\delta_e$.
Define $\delta_d$ as
\begin{equation}
    \delta_d(\hat n \chi) \equiv \int_0^\chi \ud \chi' \delta_e(\hat n \chi').
\end{equation}
It is straight-forward to show that
\begin{widetext}
\begin{equation}
C^{dd}_\ell(\chi,\chi')
    =
    \frac{2}{\pi}
    \int_0^\chi\ud\chi''
    \int_0^{\chi'}\ud\chi'''
    \int_0^\infty\ud k k^2 j_\ell(k\chi'') j_{\ell}(k\chi''')
    P_{ee}(k, (\chi''+\chi''')/2).
\end{equation}

Finally, $C^{ss}_\ell$ will contain cross terms between the stationary terms
and the integral terms.  These will have the form
\begin{equation}
C^{dx}_\ell(\chi,\chi')
    =
    \frac{2}{\pi}
    \int_0^\chi\ud\chi''
    \int_0^\infty\ud k k^2 
    j_\ell(k\chi') j_{\ell}(k\chi'')P_{ex}(k, (\chi' + \chi'')/2).
\end{equation}

Assembling all these expressions with the proper coefficients we have
\begin{align}
    \label{e:Clss}
C^{ss}_\ell(\chi,\chi') = &~
    \frac{2}{\pi}
    \int_0^\infty\ud k k^2
    j_\ell(k\chi) j_{\ell}(k\chi')
    P_{[ff + ee - 2ef]}(k, (\chi + \chi')/2)
    %\left[
    %P_{ff}(k, \bar\chi)
    %+ P_{ee}(k, \bar\chi)
    %- 2P_{fe}(k, \bar\chi)
    %\right]
    \nonumber\\
    & +
    \frac{2}{\pi}
    %\left(\frac{1}{\bar{n}_f}\frac{\ud \bar{n}_f}{\ud \chi}
    %+ \frac{2}{\chi} \right)
    %\left(\frac{1}{\bar{n}_f}\frac{\ud \bar{n}_f}{\ud \chi'}
    %+ \frac{2}{\chi'} \right)
    A(\chi) A(\chi')
    \int_0^\chi\ud\chi''
    \int_0^{\chi'}\ud\chi'''
    \int_0^\infty\ud k k^2 j_\ell(k\chi'') j_{\ell}(k\chi''')
    P_{ee}(k, (\chi''+\chi''')/2)
    \nonumber\\
    & +
    \frac{2}{\pi}
    %\left(\frac{1}{\bar{n}_f}\frac{\ud \bar{n}_f}{\ud \chi}
    %+ \frac{2}{\chi} \right)
    A(\chi)
    \int_0^\chi\ud\chi''
    \int_0^\infty\ud k k^2 
    j_\ell(k\chi') j_{\ell}(k\chi'')
    P_{[ee - fe]}(k, (\chi' + \chi'')/2)
    %\left[
    %P_{ee}(k, (\chi' + \chi'')/2)
    %- P_{fe}(k, (\chi' + \chi'')/2) 
    %\right]
    \nonumber\\
    & +
    \frac{2}{\pi}
    %\left(\frac{1}{\bar{n}_f}\frac{\ud \bar{n}_f}{\ud \chi'}
    %+ \frac{2}{\chi'} \right)
    A(\chi')
    \int_0^{\chi'}\ud\chi''
    \int_0^\infty\ud k k^2 
    j_\ell(k\chi) j_{\ell}(k\chi'')
    P_{[ee - fe]}(k, (\chi + \chi'')/2).
    %\left[ 
    %P_{ee}(k, (\chi + \chi'')/2)
    %- P_{fe}(k, (\chi + \chi'')/2) 
    %\right].
\end{align}
\end{widetext}
Here, expressions such as $P_{[ff + ee - 2ef]}$ are short hand for $P_{ff} +
P_{ee} - 2P_{ef}$.

Equation~\ref{e:Clss} can be simplified substantially by adopting the small
angle and Limber approximations \citep{extened_limber}.  The small angle
approximation eliminates the $k$ integral over spherical Bessel functions, replacing it
with a Fourier transform, and is valid for $\ell \gg 1$. The Limber
approximation assumes that only modes with small radial component of their wave
vector contribute to the radial integrals and is valid if the power spectra
evolve slowly compared to the correlation length (which has already been
assumed). With these approximations we have
\begin{comment}
\begin{align}
C^{ss}_\ell(\chi, \chi') \approx&~
    \frac{1}{\bar\chi^2}
        \int_{-\infty}^\infty\frac{\ud k_\parallel}{(2 \pi)} 
        e^{i k_\parallel (\chi - \chi')}
        P_{[ee + ff - 2ef]}
        (\sqrt{k_\parallel^2 + \ell(\ell + 1)/\bar\chi^2}, \bar\chi)
        %\left[
        %P_{ee}(\sqrt{k_\parallel^2 + \ell^2/\bar\chi^2}, \bar\chi)
        %+ P_{ff}(\sqrt{k_\parallel^2 + \ell^2/\bar\chi^2}, \bar\chi)
        %- 2 P_{ef}(\sqrt{k_\parallel^2 + \ell^2/\bar\chi^2}, \bar\chi)
        %\right]
    \nonumber \\ &+
    %\left(\frac{1}{\bar{n}_f}\frac{\ud \bar{n}_f}{\ud \chi}
    %+ \frac{2}{\chi} \right)
    %\left(\frac{1}{\bar{n}_f}\frac{\ud \bar{n}_f}{\ud \chi'}
    %+ \frac{2}{\chi'} \right)
    A(\chi) A(\chi')
    \int_0^{\chi_{\rm min}}\ud\chi''
    \frac{1}{\chi^{\prime\prime 2}}
    P_{ee}((\ell + 1/2)/\chi'',\chi'')
    \nonumber \\ &+
    %\left(\frac{1}{\bar{n}_f}\frac{\ud \bar{n}_f}{\ud \chi_{\max}}
    %+ \frac{2}{\chi_{\max}} \right)
    \frac{A(\chi_{\max})}{\chi_{\min}^2}
    P_{[ee - ef]}((\ell + 1/2)/\chi_{\min}, \chi_{\min}),
        %\left[
        %    P_{ee}(\ell/\chi_{\min}, \chi_{\min})
        %    - P_{fe}(\ell/\chi_{\min}, \chi_{\min})
        %\right],
\end{align}
\end{comment}
\begin{align}
    &C^{ss}_\ell(\chi, \chi') \approx
    \nonumber \\ & \quad
    \frac{1}{\bar\chi^2}
        \int_{-\infty}^\infty\frac{\ud k_\parallel}{(2 \pi)} 
        e^{i k_\parallel (\chi - \chi')}
        P_{[ee + ff - 2ef]}
        (\sqrt{k_\parallel^2 + \nu^2/\bar\chi^2}, \bar\chi)
    \nonumber \\ & \quad +
    A(\chi) A(\chi')
    \int_0^{\chi_{\rm min}}\ud\chi''
    \frac{1}{\chi^{\prime\prime 2}}
    P_{ee}(\nu/\chi'',\chi'')
    \nonumber \\ & \quad +
    \frac{A(\chi_{\max})}{\chi_{\min}^2}
    P_{[ee - ef]}(\nu/\chi_{\min}, \chi_{\min}),
\end{align}
where $\nu\equiv\ell + 1/2$, $\chi_{\min} \equiv \min(\chi, \chi')$,
and $\chi_{\max} \equiv \max(\chi,
\chi')$ .  We've found that these approximations are excellent for $\ell
\gtrsim 10$
and use this form for the remainder of the paper.

\subsection{Modelling the angular power-spectrum}

Description of the input power-spectra, $\bar n_f$ and figures.
Figure~\ref{f:n_f}

\begin{figure}
    \includegraphics[scale=0.42]{"figures/n_f"}
    \caption{
        \label{f:n_f}
        \red{Need to fix normalization of top panel.}
    }
\end{figure}


\section{Measurement}


DM contribution intrinsic to the source will have a few effects: There will be
an offset which will change the DM-distance relation in some way that can
hopefully be characterized. Also there will be a stochastic piece which will
smear out DM-distance relations and limit the effective width of the radial
shells. Detailed consideration of these effects is beyond the scope of this
work but to crudely deal with this, we don't consider any $\chi - \chi'$
smaller than \red{$100\,{\rm MPc}/h$}.

Contributions from local Universe probably not an issue. Can be measure by
other means and subtracted off.

Tomography is exact.  Get excellent separation of scales, unlike lensing.
The integral over $\chi$ couples many scales. In particular small scales (which
are difficult to model) will
be coupled to large angular scales by screens near the observer.  However
because tomography is exact, it would be possible to set up estimators that
decouple these scales, for instance by estimating the difference in power
between radial shells.  For this reason we start all radial integrals as
$\chi = 500\,{\rm MPc}/h$, which saves us from the difficulties in modelling the
small scale power.


\subsection{Detectability}

Here we present sensitivity estimates for a survey \ldots

We assume that the survey will be shot noise dominated as would be the case for
an initial detection.  The noise powerspectrum on a shells with of width
$\Delta \chi$ is
\begin{equation}
    C^N_{\ell, ij} = \frac{\delta_{ij}}{\bar n_f(\chi_i)\chi_i^2\Delta\chi},
\end{equation}
Here, to indicate that we are now working with quantities binned in the radial
direction instead of
continuous functions, we've switched to $C_{\ell,ij}$ over 
$C_\ell(\chi, \chi')$. The error bar on the angular
cross-power spectrum is then
\begin{align}
    (\Delta{C^{ss}_{\ell,ij}})^2 = 
    \sqrt{\frac{1}{\ell(\ell + 1)\Delta \ell f_{\rm sky}}}
        \left[C^N_{\ell,ii} C^N_{\ell,jj} +  (C^N_{\ell,ij})^2\right],
\end{align}
where the second term in brackets only contributes for $i = j$.

To give an idea of the sensitivity of the survey, we collapse
$C^{ss}_{\ell,ij}$ to a single function of $\ell$ by taking a weighted average
of all pairs of radial bins. We use bin widths of $100\,{\rm MPc}/h$ over the
range $500\,{\rm MPc}/h$ to $3600\,{\rm MPc}/h$.
For weights in the radial bin average, we use the signal to noise-squared
at $\ell=100$, which extracts all the signal to noise at that $\ell$.
We exclude the $i = j$ bin pairs due to
the presumed observational complications discussed in the previous section.
This effectively discards the contribution from the local term.

\section{Discussion and conclusions}


\begin{acknowledgments}

We would like to thank Ue-Li Pen and Mathew McQuinn for helpful discussions.
%
KWM is supported by the Canadian Institute for Advanced Research, Global Scalars
Program.

\end{acknowledgments}



\bibliography{dm_space}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%            Scrap           %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\begin{widetext}

\newpage

\section{Details not to be included}

We use the following conventions:
\begin{equation}
    P_{xy}(k, \chi) = b_x b_y g(\chi)^2 a(\chi)^2 P(k, 0)
\end{equation}

\begin{equation}
    \delta_x(\vec x, \chi) =  b_x g(\chi) a(\chi) \int\frac{\ud^3\vec k}{(2 \pi)^3}
        e^{i\vec k \cdot \vec x} \delta(\vec k, 0)
\end{equation}

\begin{equation}
    w^{xy}(\hat n \cdot \hat n', \chi, \chi')
    \equiv \langle \delta_x(\vec x) \delta_y(\vec x') \rangle
\end{equation}

For any statistically stationary tracers $x$ and $y$,
ignoring time dependance (redshift evolution)
of the power spectrum:
\begin{align}
    \delta_{\ell\ell'}\delta_{mm'}C^{xy}_\ell(\chi, \chi')
    &= \int\ud\Omega\ud\Omega'Y_{\ell m}(\hat n) Y_{\ell' m'}(\hat n')
        \langle \delta^x(\hat n \chi) \delta^y(\hat n' \chi') \rangle
        \\
    &=
        \int\ud\Omega\ud\Omega'Y_{\ell m}(\hat n) Y_{\ell' m'}(\hat n')
        \int\frac{\ud^3\vec k}{(2 \pi)^3} \frac{\ud^3\vec k'}{(2 \pi)^3}
        e^{i\vec k \cdot \vec x} e^{i\vec k' \cdot \vec x'}
        \langle \delta(\vec k) \delta(\vec k') \rangle
        \\
    &=
        \int\ud\Omega\ud\Omega'Y_{\ell m}(\hat n) Y_{\ell' m'}(\hat n')
        \int\frac{\ud^3\vec k}{(2 \pi)^3} 
        e^{i\vec k \cdot (\vec x - \vec x')} P_{xy}(k)
        \\
    &=
        \int\frac{\ud^3\vec k}{(2 \pi)^3} P_{xy}(k)
        \int\ud\Omega Y_{\ell m}(\hat n)
        e^{i\vec k \cdot \vec x}
        \int\ud\Omega' Y_{\ell' m'}(\hat n')
        e^{-i\vec k \cdot \vec x'}
        \\
    &=
        \int\frac{\ud^3\vec k}{(2 \pi)^3} P_{xy}(k)
        \left[(4 \pi) i^\ell j_\ell(k\chi) Y_{\ell m}^*(\hat k)\right]
        \left[(4 \pi) i^{-\ell'} j_{\ell'}(k\chi') Y_{\ell' m'}(\hat
        k)\right]
        \\
    &=
        \frac{2}{\pi}
        \int_0^\infty\ud k k^2 j_\ell(k\chi) j_{\ell'}(k\chi')P_{xy}(k)
        \int\ud \Omega_k i^{(\ell - \ell')}
        Y_{\ell' m'}^*(\hat k) Y_{\ell m}(\hat k)
        \\
    &= \delta_{\ell\ell'}\delta_{mm'}\frac{2}{\pi}
        \int_0^\infty\ud k k^2  j_\ell(k\chi) j_{\ell}(k\chi')P_{xy}(k)
        \\
    C^{xy}_\ell(\chi,\chi') 
    &= \frac{2}{\pi}
\int_0^\infty\ud k k^2 j_\ell(k\chi) j_{\ell}(k\chi')P_{xy}(k)
\end{align}

It is convienient to reparameterize this in terms of
$\bar\chi \equiv (\chi + \chi') /2$ and $\Delta \chi \equiv \chi' - \chi$.
We expect the power spectrum to vary slowly as a function of $\bar\chi$ and
very quickly as a function of $\Delta\chi$. However it will be highly
suppressed for $\ell \gg \bar\chi/\Delta\chi$. These facts will be very
helpfull in subsequent numerical integrals.

Also since smallish value of $\Delta\chi$ are of interest, this leads us to
an obviouse way to include redshift dependance of the
power spectrum:
\begin{equation}
C^{xy}_\ell(\bar\chi,\Delta\chi) 
    = \frac{2}{\pi}
    \int_0^\infty\ud k k^2
    j_\ell(k\chi) j_{\ell}(k\chi')
    P_{xy}(k,\bar\chi) \qquad \Delta\chi \ll 1/aH
\end{equation}

Define $\delta_d$ as:
\begin{equation}
    \delta_d(\hat n \chi) = \int_0^\chi \ud \chi' \delta_e(\hat n \chi')
\end{equation}
which doesn't have the same units as over-density, but that is okay.
\begin{equation}
C^{dd}_\ell(\chi,\chi')
    =
    \frac{2}{\pi}
    \int_0^\chi\ud\chi''
    \int_0^{\chi'}\ud\chi'''
    \int_0^\infty\ud k k^2 j_\ell(k\chi'') j_{\ell}(k\chi'''
    )P_{ee}(k, (\chi''+\chi''')/2)
\end{equation}

For numerical integration, perform the following change of variables to make
things much easier.
\begin{align}
C^{dd}_\ell(\chi,\chi')
&=
    \frac{2}{\pi}
    \int_0^{(\chi' + \chi)/2}\ud\bar\chi'
    \int_{\max(-2\bar\chi', -2(\chi -\bar\chi'))}^{\min(2\bar\chi', 2(\chi' -
    \bar\chi'))}\ud\Delta'
    \int_0^\infty\ud k k^2 j_\ell(k(\bar\chi' - \Delta'/2))
    j_{\ell}(k(\bar\chi' + \Delta'/2))
    P_{ee}(k, \bar\chi')
    \\
    &\approx
    \frac{4}{\pi}
    \int_0^{\chi_m}\ud\bar\chi'
    \int_{0}^{\infty}\ud\Delta'
    \int_0^\infty\ud k k^2 j_\ell(k(\bar\chi' - \Delta'/2))
    j_{\ell}(k(\bar\chi' + \Delta'/2))
    P_{ee}(k, \bar\chi')
\end{align}
At this point we could again to the transformation to $C_{\ell\chi\chi'}$
leaving the expression as a triple integral. This is not as computationally
costly as might be expected at first glance, since the $\chi''$ and $\chi'''$
integrals are almost the same for all $\chi$, $\chi'$ pairs with only the
limits of integration changing. Thus the full set of $C_{\ell\chi\chi'}$'s can
be computed with a cumulative sum, only performing one new integral (over $k$)
for each element.

Finally, the cross terms:
\begin{equation}
C^{dx}_\ell(\chi,\chi')
    =
    \frac{2}{\pi}
    \int_0^\chi\ud\chi''
    \int_0^\infty\ud k k^2 
    j_\ell(k\chi') j_{\ell}(k\chi'')P_{ex}(k, (\chi' + \chi'')/2)
\end{equation}

with the following change of variables for numerical integration:
\begin{align}
C^{dx}_\ell(\chi,\chi')
    =&
    \frac{2}{\pi}
    \int_{-\chi'}^{\chi - \chi'}\ud\Delta'
    \int_0^\infty\ud k k^2 j_\ell(k\chi')
    j_{\ell}(k(\chi'+\Delta'))
    P_{ex}(k, \chi' + \Delta'/2)
    \\
C^{dx}_\ell(\chi,\chi') + C^{xd}_\ell(\chi,\chi')
    \approx&
    \frac{2}{\pi}
    \int_{-\chi'}^{\chi - \chi'}\ud\Delta'
    \int_0^\infty\ud k k^2 j_\ell(k(\chi'-\Delta'/2))
    j_{\ell}(k(\chi'+\Delta'/2))
    P_{ex}(k, \chi')
    \nonumber\\
    &+
    \frac{2}{\pi}
    \int_{-\chi}^{\chi' - \chi}\ud\Delta'
    \int_0^\infty\ud k k^2 j_\ell(k(\chi-\Delta'/2))
    j_{\ell}(k(\chi+\Delta'/2))
    P_{ex}(k, \chi)\\
    \approx&
    \frac{\red{4}}{\pi}
    \int_{0}^{\infty}\ud\Delta'
    \int_0^\infty\ud k k^2 j_\ell(k(\chi_m-\Delta'/2))
    j_{\ell}(k(\chi_m+\Delta'/2))
    P_{ex}(k, \chi_m)
\end{align}
The second line exploits the fact that for $\ell \gg 1$, $\chi \gg \chi'/\ell$ and
$\chi' \gg \chi/\ell$, only $\Delta'\ll\chi$ contributes significantly to the
integral. Also the expressions are very weak functions of $\chi$ and thus
may be shifted by $\Delta/2$ without incurring much error. The third line
exploits the fact that only one term contributes if $\chi$ and $\chi'$ are
widely separated, and if they are close then the two terms combine to the given
expression.

\red{Actually, with the approximations we've made, we can actually do the
$\Delta$ integrals analytically by transferring all the $\Delta$ to a single
Bessel and shifting the power spectrum to be independent of $\Delta$.  Should
be pretty good for $\ell > 10$.  That is nice because it will control all our
numerical issues with oscillating Bessel functions.}

Assembling terms:
\begin{align}
C^{ss}_\ell(\chi,\chi') = &
    \frac{2}{\pi}
    \int_0^\infty\ud k k^2
    j_\ell(k\chi) j_{\ell}(k\chi')
    \left[ P_{ff}(k, \bar\chi)
    + P_{ee}(k, \bar\chi)
    - 2P_{fe}(k, \bar\chi) \right]
    \nonumber\\
    & +
    \frac{2}{\pi}
    \left(\frac{1}{\bar{n}_f}\frac{\ud \bar{n}_f}{\ud \chi}
    + \frac{2}{\chi} \right)
    \left(\frac{1}{\bar{n}_f}\frac{\ud \bar{n}_f}{\ud \chi'}
    + \frac{2}{\chi'} \right)
    \int_0^\chi\ud\chi''
    \int_0^{\chi'}\ud\chi'''
    \int_0^\infty\ud k k^2 j_\ell(k\chi'') j_{\ell}(k\chi''')
    P_{ee}(k, (\chi''+\chi''')/2)
    \nonumber\\
    & +
    \frac{2}{\pi}
    \left(\frac{1}{\bar{n}_f}\frac{\ud \bar{n}_f}{\ud \chi}
    + \frac{2}{\chi} \right)
    \int_0^\chi\ud\chi''
    \int_0^\infty\ud k k^2 
    j_\ell(k\chi') j_{\ell}(k\chi'')
    \left[ P_{ee}(k, (\chi' + \chi'')/2)
    - P_{fe}(k, (\chi' + \chi'')/2) \right]
    \nonumber\\
    & +
    \frac{2}{\pi}
    \left(\frac{1}{\bar{n}_f}\frac{\ud \bar{n}_f}{\ud \chi'}
    + \frac{2}{\chi'} \right)
    \int_0^{\chi'}\ud\chi''
    \int_0^\infty\ud k k^2 
    j_\ell(k\chi) j_{\ell}(k\chi'')
    \left[ P_{ee}(k, (\chi + \chi'')/2)
    - P_{fe}(k, (\chi + \chi'')/2) \right]
\end{align}

\section{Small angles and Limber}

Alternately, on the flat sky and for small angles:
\begin{align}
(2\pi)^2\delta^2(\vec \ell - \vec \ell')C_\ell(\chi, \chi')
    &=
        \int\ud^2\vec\theta\ud^2\vec\theta'
        e^{-i\vec\ell\cdot\vec\theta} e^{-i\vec\ell'\cdot\vec\theta'}
        \langle \delta(\hat n \chi) \delta(\hat n' \chi') \rangle
        \\
    &\approx
        \int\ud^2\vec\theta\ud^2\vec\theta'
        e^{-i\vec\ell\cdot\vec\theta} e^{-i\vec\ell'\cdot\vec\theta'}
        \int\frac{\ud^3\vec k}{(2 \pi)^3} 
        e^{i\vec k \cdot (\vec x - \vec x')} P(k, \bar\chi)
        \\
    &=
        \int\frac{\ud^3\vec k}{(2 \pi)^3} 
        e^{i k_\parallel (\chi - \chi')} P(k, \bar\chi)
        \int\ud^2\vec\theta e^{-i(\vec\ell-\bar\chi\vec k_\bot)\cdot\vec\theta}
        \int\ud^2\vec\theta' e^{-i(\vec\ell'-\bar\chi\vec k_\bot)\cdot\vec\theta'}
        \\
    &=
        \int\frac{\ud^3\vec k}{(2 \pi)^3} 
        e^{i k_\parallel (\chi - \chi')} P(\sqrt{k_\parallel^2 + k_\bot^2}, \bar\chi)
        (2\pi)^4 \delta^2(\vec\ell - \bar\chi \vec k_\bot)
        \delta^2(\vec\ell' - \bar\chi\vec k_\bot)
        \\
    &=
        \int_{-\infty}^\infty\frac{\ud k_\parallel}{(2 \pi)} 
        e^{i k_\parallel (\chi - \chi')}
        P(\sqrt{k_\parallel^2 + \ell^2/\bar\chi^2}, \bar\chi)
        \frac{(2\pi)^2\delta^2(\vec\ell' - \vec \ell)}{\bar\chi^2}
        \\
C_\ell(\chi, \chi')
    &= \frac{1}{\bar\chi^2}
        \int_{-\infty}^\infty\frac{\ud k_\parallel}{(2 \pi)} 
        e^{i k_\parallel (\chi - \chi')}
        P(\sqrt{k_\parallel^2 + \ell^2/\bar\chi^2}, \bar\chi)
\end{align}
Which is valid for $\ell \gg 1$ and $\chi - \chi' \ll \bar\chi$.
$\bar \chi \equiv (\chi + \chi') /2$


Or for flat sky and small angles:
\begin{align}
C^{dd}_\ell(\chi,\chi') 
    &=
    \int_0^\chi\ud\chi''
    \int_0^{\chi'}\ud\chi'''
    \frac{1}{\bar\chi^{\prime 2}}
    \int_{-\infty}^\infty\frac{\ud k_\parallel}{(2 \pi)} 
    e^{i k_\parallel (\chi'' - \chi''')}
    P_{ee}(\sqrt{k_\parallel^2 + \ell^2/\bar\chi^2}, (\chi'' + \chi''')/2)
    \\
    &\approx
    \int_0^\chi\ud\chi''
    \int_0^{\chi'}\ud\chi'''
    \frac{1}{\bar\chi^{\prime 2}}
    \int_{-\infty}^\infty\frac{\ud k_\parallel}{(2 \pi)} 
    e^{i k_\parallel (\chi'' - \chi''')}
    P_{ee}(\ell/\bar\chi', (\chi'' + \chi''')/2)
    \\
    &=
    \int_0^\chi\ud\chi''
    \int_0^{\chi'}\ud\chi'''
    \frac{1}{\bar\chi^{\prime 2}}
    \delta(\chi'' - \chi''')
    P_{ee}(\ell/\bar\chi', (\chi'' + \chi''')/2)
    \\
    &=
    \int_0^{\min(\chi,\chi')}\ud\chi''
    \left(\frac{1}{\chi''}\right)^2
    P_{ee}(\ell/\chi'', \chi'')
\end{align}
where the second line applies Limber's approximation. 
$\bar\chi' \equiv (\chi'' + \chi''')/2$.

Or under Limber:
\begin{align}
C^{dx}_\ell(\chi,\chi')
    &=
    \int_0^\chi\ud\chi''
    \frac{1}{\bar\chi^{\prime 2}}
    \delta(\chi'' - \chi')
    P_{ex}(\ell/{\bar\chi'}, (\chi'' + \chi')/2)
    \\
    &=
    \left(\frac{1}{\chi'}\right)^2
    P_{ex}(\ell/\chi', \chi')
    \qquad \textrm{if $\chi' < \chi$ and 0 otherwise.}
%    \\
%C^{dx}_\ell(\chi,\chi') + C^{xd}_\ell(\chi,\chi')
%    &=
%    \left(\frac{1}{\chi^m}\right)^2
%    P_{ex}(\ell/\chi^m, \chi_m)
\end{align}

Accumulating all terms for Limber and assuming a linear bias model:
\begin{align}
C^{ss}_\ell(\chi, \chi') =&~
    \left(\frac{b_f - b_e }{\bar\chi}\right)^2
        \int_{-\infty}^\infty\frac{\ud k_\parallel}{(2 \pi)} 
        e^{i k_\parallel \Delta\chi}
        P(\sqrt{k_\parallel^2 + \ell^2/\bar\chi^2}, \bar\chi)
    \nonumber \\ &+
    \left(\frac{1}{\bar{n}_f}\frac{\ud \bar{n}_f}{\ud \chi_m}
    + \frac{2}{\chi_m} \right)^2
    b_e^2 \int_0^{\chi_m}\ud\chi''
    \frac{1}{\chi^{\prime\prime 2}}
        P(\ell/\chi'',\chi'')
    \nonumber \\ &+
    \left(\frac{1}{\bar{n}_f}\frac{\ud \bar{n}_f}{\ud \chi_m}
    + \frac{2}{\chi_m} \right)
    \frac{b_e(-b_f + b_e)}{\chi_m^2}
        P(\ell/\chi_m, \chi_m)
\end{align}
where $\chi_m \equiv \min(\chi, \chi')$.

\end{widetext}

\end{document}
